# ラテン方格法の検証ガイド

## ラテン方格法の仕組み

この実験では、4つのセット（各セット3ペア）に4つの条件（A, B, C, D）を割り当てるラテン方格法を使用しています。

### パターン定義

被験者IDを4で割った余りで、以下のパターンが割り当てられます：

| 被験者ID | パターン | セット1 | セット2 | セット3 | セット4 |
|---------|---------|---------|---------|---------|---------|
| 1, 5, 9, 13... | パターン1 | A | B | C | D |
| 2, 6, 10, 14... | パターン2 | B | C | D | A |
| 3, 7, 11, 15... | パターン3 | C | D | A | B |
| 4, 8, 12, 16... | パターン4 | D | A | B | C |

## 必要な被験者数

### 最低限: 4人

- **被験者1**: パターン1（セット1→A, セット2→B, セット3→C, セット4→D）
- **被験者2**: パターン2（セット1→B, セット2→C, セット3→D, セット4→A）
- **被験者3**: パターン3（セット1→C, セット2→D, セット3→A, セット4→B）
- **被験者4**: パターン4（セット1→D, セット2→A, セット3→B, セット4→C）

**結果**: 各セット×各条件 = 1回ずつ（最小限のバランス）

### 推奨: 8人

- 各セット×各条件 = 2回ずつ
- より統計的に安定した結果が得られます

### 理想: 12人

- 各セット×各条件 = 3回ずつ
- 統計分析に最適なバランス

### より多くの被験者: 16人、20人...

- 4の倍数であれば、均等なバランスが保たれます

## 検証クエリ

### 1. 現在の被験者数を確認

```sql
SELECT COUNT(DISTINCT participant_id) as participant_count
FROM experiment_results;
```

### 2. ラテン方格法が正しく機能しているか確認

```sql
-- 各セット×各条件の組み合わせ数
SELECT 
  set_id,
  condition,
  COUNT(*) as trial_count,
  COUNT(DISTINCT participant_id) as participant_count
FROM experiment_results
WHERE set_id IS NOT NULL
GROUP BY set_id, condition
ORDER BY set_id, condition;
```

**期待される結果**:
- 4人の場合: 各セット×各条件 = 1回ずつ（合計16セル、各1回）
- 8人の場合: 各セット×各条件 = 2回ずつ（合計16セル、各2回）
- 12人の場合: 各セット×各条件 = 3回ずつ（合計16セル、各3回）

### 3. 被験者ごとの条件分布を確認

```sql
SELECT 
  participant_id,
  condition,
  COUNT(*) as trial_count
FROM experiment_results
GROUP BY participant_id, condition
ORDER BY participant_id::integer, condition;
```

**期待される結果**: 各被験者が各条件を3回ずつ（各セット1回 × 3ペア = 3回）

### 4. ノードペアの条件カバレッジを確認

```sql
-- 各ノードペアがすべての条件で見られるか確認
SELECT 
  node_pair_id,
  COUNT(DISTINCT condition) as condition_count,
  STRING_AGG(DISTINCT condition, ', ' ORDER BY condition) as conditions,
  COUNT(DISTINCT participant_id) as participant_count
FROM experiment_results
WHERE node_pair_id IS NOT NULL
GROUP BY node_pair_id
ORDER BY node_pair_id;
```

**期待される結果**: 
- 各ノードペアが4つの条件すべてで見られる
- `condition_count = 4`であること

## 推奨される被験者数

### 研究の目的による

1. **予備実験・パイロット研究**: 4人で十分
   - ラテン方格法が正しく機能しているか確認
   - 実験手順の検証

2. **本格的な実験**: 8-12人を推奨
   - 統計的に意味のある結果を得るため
   - 条件間の比較が可能

3. **論文発表レベルの研究**: 12人以上
   - より信頼性の高い統計分析
   - 効果量の検出が可能

### 現在の状況での推奨

**1人しか実施していない場合**:

1. **まず4人で検証**（最低限）
   - ラテン方格法が正しく機能しているか確認
   - 実験手順に問題がないか確認

2. **その後、必要に応じて追加**
   - 予備実験なら4人で十分
   - 本格的な実験なら8-12人を推奨

## 被験者IDの割り当て

**重要**: 被験者IDは順番に1, 2, 3, 4...と割り当ててください。

- 被験者1 → パターン1
- 被験者2 → パターン2
- 被験者3 → パターン3
- 被験者4 → パターン4
- 被験者5 → パターン1（被験者1と同じ）
- 被験者6 → パターン2（被験者2と同じ）
- ...

## 検証チェックリスト

実験を進める前に、以下を確認してください：

- [ ] 被験者IDが1から順番に割り当てられている
- [ ] 各被験者が全24トライアル（タスクA: 12、タスクB: 12）を完了している
- [ ] 各被験者が各条件（A, B, C, D）を3回ずつ体験している
- [ ] 各ノードペアが4つの条件すべてで見られている
- [ ] 各セット×各条件の組み合わせが均等に割り当てられている

## トラブルシューティング

### 被験者数が4の倍数でない場合

例: 5人、6人、7人など

- ラテン方格法は機能しますが、バランスが不均等になります
- 可能であれば、4の倍数（4, 8, 12, 16...）に調整することを推奨

### データが不完全な場合

```sql
-- 各被験者の完了トライアル数を確認
SELECT 
  participant_id,
  COUNT(*) as completed_trials,
  COUNT(DISTINCT task) as tasks_completed
FROM experiment_results
GROUP BY participant_id
ORDER BY participant_id::integer;
```

**期待値**: 各被験者が24トライアル完了（タスクA: 12、タスクB: 12）

## 次のステップ

1. **まず4人で検証**
   - ラテン方格法が正しく機能しているか確認
   - 実験手順に問題がないか確認

2. **データを確認**
   - 上記の検証クエリを実行
   - 期待通りの結果が得られているか確認

3. **必要に応じて追加**
   - 予備実験なら4人で十分
   - 本格的な実験なら8-12人を推奨

